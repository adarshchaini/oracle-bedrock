<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-05-02 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160502" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Oracle Tools &#x2013; Introduction to Deferred References</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.1.min.js"></script>

                          
        
<script src="js/site.js" type="text/javascript"></script>
                      
        
<link rel="shortcut icon" href="images/oracletools-logo.ico"/>
          
                  </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/coherence-community/bedrock/">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Bedrock Site</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2016-05-02
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 4.0.0-SNAPSHOT
                      </li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Oracle Tools</li>
                              
      <li>
  
                          <a href="../index.html" title="Welcome">
          <i class="none"></i>
        Welcome</a>
            </li>
                
      <li>
  
                          <a href="../adoption.html" title="Adoption">
          <i class="none"></i>
        Adoption</a>
            </li>
                
      <li>
  
                          <a href="../history.html" title="Change History">
          <i class="none"></i>
        Change History</a>
            </li>
                              <li class="nav-header">Recommended Reading</li>
                              
      <li class="active">
  
            <a href="#"><i class="none"></i>Deferred References</a>
          </li>
                
      <li>
  
                          <a href="../runtime/applications.html" title="Application Management">
          <i class="none"></i>
        Application Management</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="../core/index.html" title="Core Module">
          <i class="none"></i>
        Core Module</a>
            </li>
                
      <li>
  
                          <a href="../runtime/index.html" title="Runtime Module">
          <i class="none"></i>
        Runtime Module</a>
            </li>
                
      <li>
  
                          <a href="../testing-support/index.html" title="Testing Support Module">
          <i class="none"></i>
        Testing Support Module</a>
            </li>
                
      <li>
  
                          <a href="../coherence/index.html" title="Coherence Module">
          <i class="none"></i>
        Coherence Module</a>
            </li>
                              <li class="nav-header">Development</li>
                              
      <li>
  
                          <a href="../license.html" title="License">
          <i class="none"></i>
        License</a>
            </li>
                
      <li>
  
                          <a href="../release-numbers.html" title="Release Numbers">
          <i class="none"></i>
        Release Numbers</a>
            </li>
                
      <li>
  
                          <a href="../source-code.html" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
                
      <li>
  
                          <a href="../building.html" title="Build Instructions">
          <i class="none"></i>
        Build Instructions</a>
            </li>
                
      <li>
  
                          <a href="../issue-tracking.html" title="Issue Tracking">
          <i class="none"></i>
        Issue Tracking</a>
            </li>
                
      <li>
  
                          <a href="../contributions.html" title="Contributions">
          <i class="none"></i>
        Contributions</a>
            </li>
                
      <li>
  
                          <a href="../logging.html" title="Logging">
          <i class="none"></i>
        Logging</a>
            </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section">
<h2><a name="Introduction_to_Deferred_References"></a>Introduction to Deferred References</h2>

<blockquote>
<p>We highly recommend that you invest some time to work through the content  and examples in this document. This investment will be invaluable in  helping you create great concurrent and distributed tests!</p>
</blockquote>
<hr />

<div class="section">
<div class="section">
<h4><a name="The_Twenty_Second_Synopsis"></a>The Twenty Second Synopsis</h4>
<p><b>What?</b> Deferred References are a mechanism to represent resources that have yet to become available.</p>
<p><b>When?</b> Use Deferred References when you feel you need to use <tt>Thread.sleep(...)</tt> to wait for resources to become available. A Deferred Reference can be used to represent the resource that you want to wait (sleep) upon.</p>
<p><b>Why?</b> Using <tt>Thread.sleep(...)</tt>, especially in application tests, can introduce all kinds of concurrency related issues. It&#x2019;s generally best to avoid them.</p>
<p><b>How?</b> Read this document to find out.</p>
<p><b>Where?</b> Deferred References are defined in the following Maven module and Java package:</p>

<ul>
  
<li>Maven Group Id: <tt>com.oracle.bedrock</tt></li>
  
<li>Maven Artifact Id: <tt>oracle-tools-core</tt></li>
  
<li>Maven Version: <tt>4.0.0-SNAPSHOT</tt></li>
  
<li>Java Package: <tt>com.oracle.bedrock.deferred</tt></li>
</ul>
<hr />
</div>
<div class="section">
<h4><a name="Overview"></a>Overview</h4>
<p>A <i>Deferred Reference</i>, commonly abbreviated to simply a <i>Deferred</i>, is an object that represents a reference another strongly-typed object, that of which may not be available at the time the Deferred was created or may have varying availability characteristics during its&#x2019; lifetime.</p>
<p>Application developers typically use Deferreds as a means to separate the concepts of a). representing resources with questionable availability, and b). the mechanisms for ensuring that the underlying resources are available when required.</p>

<blockquote>
<p>In programmatic terms, <i>Deferreds</i> are represented by the  <tt>com.oracle.bedrock.deferred.Deferred</tt> interface, as defined in the  <tt>oracle-tools-core</tt> module.</p>
</blockquote>
<p>The following statement defines a Deferred for an MBean (of type T) that of which may or may not have been registered by an application (because MBean Server setup and MBean registrations typically occur asynchronously). This kind of statement would commonly be found in an application or a test, that makes use of an MBean defined by a remote application.</p>

<div class="source">
<div class="source">
<pre>Deferred&lt;T&gt; deferredMBean = application.getDeferredMBeanProxy(name, T.class);
</pre></div></div>
<p>After this statement an application developer may attempt to acquire the MBean using the following:</p>

<div class="source">
<div class="source">
<pre>T t = deferredMBean.get();
</pre></div></div>
<p>Should the underlying deferred resource, an MBean (of type T) not be available, a <tt>TemporarilyUnavailableException</tt> will be thrown. Should it be determined that the MBean will never become available, a <tt>PermanentlyUnavailableException</tt> would be thrown.</p>

<blockquote>
<p>The mechanism to ensure that Deferred resources are available when requested,  instead of handling exceptions and implementing retry semantics yourself, is  covered shortly.</p>
</blockquote>
</div>
<div class="section">
<h4><a name="Deferreds_vs_Futures"></a>Deferreds v's Futures</h4>
<p>While Deferreds may seem similar to Java Futures, Deferreds are not Futures.</p>
<p>Futures are typically used to provide a mechanism to:</p>
<p>a). represent and acquire the &#x201c;future&#x201d; result of some computation that has been submitted or is occurring asynchronously, and</p>
<p>b). cancel the computation callable before or during asynchronous computation.</p>
<p>From an application developer perspective, calling either the <tt>Future.get()</tt> or <tt>Future.get(long, java.util.concurrent.TimeUnit)</tt> always blocks the calling thread, at least for some period of time, to wait for a result. More specifically, how a calling thread waits for a result of a Future is &#x201c;built into&#x201d; the Future implementation itself, with provides little option for an application developer to control the underlying semantics, especially retry, failure and eventually giving up.</p>
<p>Conversely calling Deferred.get() never blocks the calling thread, unless of course the underlying Deferred implementation provides this facility.</p>
<p>This difference is very significant. Where as Futures typically have hard-coded blocking retry semantics, Deferreds allow numerous mechanisms for lazily evaluation to be provided, extended or overridden.</p>
<p>Furthermore, in more advanced use-cases Deferreds may be used as part of requests to create other Deferreds, thus forming nested chains of resources that of which are dependent upon each other, without forcing developers to write retry logic between each resource. This allows traditionally complex interactions between asynchronous resources and conditions to be elegantly specified while at the same time separating how retry may occur.</p>
</div>
<div class="section">
<h4><a name="Deferreds_vs_Builders_and_Factories"></a>Deferreds v's Builders and Factories</h4>
<p>While Deferreds may seem similar to Builders or Factories, they are neither Builders or Factories. Where as each Deferred is designed to encapsulate how to acquire a single well-known identifiable object, Builders and Factories are typically used to construct/realize/build a number of objects.</p>
<p>For example, a Deferred may be used to represent a connection to a specific server, that of which has yet to start, where as a connection builder/factory would instead be used to create numerous connections to any number of servers.</p>
<p>As there are many types of Deferreds, each with their own strategies for dealing with object acquisition, recovering from acquisition failure and handling certainly types of objects, consideration should be made as to the choice of Deferred types to ensure that correct semantics are achieved.</p>
</div>
<div class="section">
<h4><a name="Ensuring_Deferred_Resources_are_Available"></a>Ensuring Deferred Resources are Available</h4>
<p>Eventually all applications will need the underlying resource that a Deferred represents. While it&#x2019;s possible for application developers to implement mechanisms to ensure that a resource is available, this is not encouraged. Instead a special type of Deferred implementation, called an <i>Ensured</i> should be used.</p>
<p>An <i>Ensured</i> Reference is a <i>Deferred</i> Reference implementation attempts to guarantee, through numerous strategies, that an underlying resource is available when requested by an application and if not a <tt>PermanentlyUnavailableException</tt> is thrown.</p>
<p>Naturally they are used in the same manner that Deferreds are used - they implement the <tt>com.oracle.bedrock.deferred.Deferred</tt> interface - with the exception that when calling <tt>Ensured.get()</tt>, the calling Thread may block.</p>

<blockquote>
<p>In this way Ensureds are like Futures (except that there&#x2019;s no concept  of <tt>Future.cancel()</tt>).</p>
</blockquote>
<p>The simplest way to ensure Deferreds is to use the static helper methods provided by the <tt>com.oracle.bedrock.deferred.DeferredHelper</tt> class, in particular the <tt>ensure</tt> methods.</p>
<p><b>Example: Ensuring a Deferred Resource</b></p>

<div class="source">
<div class="source">
<pre>//from module oracle-tools-core
static import com.oracle.bedrock.deferred.DeferredHelper.*;

...

// acquire a Deferred representation of the MBean
Deferred&lt;T&gt; deferredMBean = application.getDeferredMBeanProxy(name, T.class);

// acquire a Deferred that is ensured to return the MBean when calling &quot;get&quot;
Deferred&lt;T&gt; ensuredMBean = ensure(deferredMBean);

// this will wait for the MBean to become registered or
// throw a PermanentlyUnavailableException.
T t = ensuredMBean.get();
</pre></div></div>
<p>While it might seem strange to separate the concept of defining the resource and that of attempting to guarantee the resource is available, doing so significantly increases the expressiveness of the API.</p>

<blockquote>
<p>The maximum amount of time an Ensured implementation will wait before an  <tt>PermanentlyUnavailableException</tt> is thrown is configurable. By default this  is 60 seconds. Likewise the strategy used to determine when an underlying  resource is available, is also configurable - though somewhat dependent  on the type of Deferred being ensured. For more information refer to the  Java Documentation for the <tt>com.oracle.bedrock.deferred.Ensured</tt> and  <tt>com.oracle.bedrock.deferred.DeferredHelper</tt> classes.</p>
</blockquote>
</div>
<div class="section">
<h4><a name="Deferred_Method_Invocation"></a>Deferred Method Invocation</h4>
<p>Say that our MBean defines a method called <tt>getCount</tt> that returns an <tt>int</tt>. Normally and somewhat naturally, it&#x2019;s reasonable to expect that we can&#x2019;t make calls to this method unless the underlying MBean is actually available. However using Deferreds (and some additional helpers), we don&#x2019;t have this constraint as we&#x2019;re free to call methods on Deferred references, to produce Deferred results, even when the underlying resources are unavailable!</p>
<p><b>Example: Deferred Method Invocation</b></p>

<div class="source">
<div class="source">
<pre>//from module oracle-tools-core
static import com.oracle.bedrock.deferred.DeferredHelper.*;

...

// acquire a Deferred representation of the MBean
Deferred&lt;T&gt; deferredMBean = application.getDeferredMBeanProxy(name, T.class);

// create a Deferred that represents calling &quot;getCount&quot; on the deferredMBean
Deferred&lt;Integer&gt; deferredCount = eventually(invoking(deferredMBean).getCount());
</pre></div></div>
<p>Here we use the combination of the <tt>eventually</tt> and <tt>invoking</tt> helpers to capture the call sequence to <tt>getCount</tt>, the result of which is a Deferred that represents the method call on the Deferred MBean.</p>
<p>Now when we call <tt>get</tt> on our &#x201c;deferredCount&#x201d; it will attempt to resolve the underlying MBean, and if available, call <tt>getCount</tt> for us! Importantly, note that there&#x2019;s <b>no requirement</b> to implement logic to &#x201c;wait&#x201d; or &#x201c;ensure&#x201d; that the MBean is available.</p>

<blockquote>
<p><b>How does this work?</b> The <tt>invoking</tt> helper creates a dynamic-proxy of the  class of the Deferred (as the Deferred may not be available). The subsequent  method interactions with proxy are then recorded - the methods aren&#x2019;t actually  called. Afterwards the <tt>eventually</tt> helper converts those method interfactions  into a new Deferred, that of which represents the said calls onto the underlying  Deferred. When <tt>get</tt> is called on the Deferred returned by the <tt>eventually</tt>  helper, the Deferred will attempt perform the actual method call on the  original Deferred resource.</p>
</blockquote>
</div>
<div class="section">
<h4><a name="Deferreds_and_Testing"></a>Deferreds and Testing</h4>
<p>One of the major uses of Deferreds is to simplify writing assertions in concurrent and distributed computing environments, especially against resources that may or may not be available.</p>
<p>Say we may want to test that the value of an MBean in a remote process, that of which is being updated asynchronously, reaches a desired value in a certain amount of time. We can represent this condition through the use of Deferreds, and especially, DeferredMatches.</p>
<p><b>Example: Deferred Matching (with Hamcrest)</b></p>

<blockquote>
<p>The following example makes use of Hamcrest Matchers to represent matching  conditions. More information about Hamcrest Matchers can be found here:  <a class="externalLink" href="https://code.google.com/p/hamcrest/wiki/Tutorial" title="The Hamcrest Tutorial">The Hamcrest Tutorial</a>.</p>
</blockquote>

<div class="source">
<div class="source">
<pre>//from module oracle-tools-core
static import com.oracle.bedrock.deferred.DeferredHelper.*;

//from module oracle-tools-testing-support
import com.oracle.bedrock.deferred.DeferredMatch;

// acquire a Deferred representation of the MBean
Deferred&lt;T&gt; deferredMBean = application.getDeferredMBeanProxy(name, T.class);

// create a Deferred that represents calling getCount on the deferredMBean
Deferred&lt;Integer&gt; deferredCount = eventually(invoking(deferredMBean).getCount());

// create a DeferredMatch that represents the count reaching 3
Deferred&lt;Boolean&gt; deferredMatch = new DeferredMatch(deferredCount, is(3));
</pre></div></div>
<p>Of course, this does not perform the assert operation for you. It simply creates a Deferred to represent the match that should occur at some point! To actually assert that the condition holds, we need to use the enhanced &#x201c;assertThat&#x201d; method from the <tt>com.oracle.bedrock.deferred.Eventually</tt> class.</p>
<p><b>Example: Eventually.assertThat</b></p>

<div class="source">
<div class="source">
<pre>//from module oracle-tools-core
static import com.oracle.bedrock.deferred.DeferredHelper.*;

//from module oracle-tools-testing-support
static import com.oracle.bedrock.deferred.Eventually.*;

// acquire a Deferred representation of the MBean
Deferred&lt;T&gt; deferredMBean = application.getDeferredMBeanProxy(name, T.class);

// assert that the MBean.getCount() method eventually returns 3
Eventually.assertThat(invoking(deferredMBean).getCount(), is(3));
</pre></div></div>
<p>While in the previous example we made use of the DeferredMatch class, when using <tt>Eventually.assertThat</tt>, this is not required. We can simply provide a Deferred and a Hamcrest Matcher. The <tt>assertThat</tt> method implementation does the rest, including ensuring that the Deferred is available and that the value produced matches the condition specified.</p>
<p>This approach is not only simple, it&#x2019;s powerful and expressive. There&#x2019;s no requirement on part of the developer to ensure each of the possible resources are available, especially when there are nested dependencies in this case. Furthermore there&#x2019;s no requirement to &#x201c;retry&#x201d; should failures occur.</p>
<p>Additionally there are no <tt>Thread.sleep(...)</tt> calls, which means that almost all time-sensitive issues are eliminated from tests, thus increasing the overall reliablility and reducing the timing-related issues commonly found when implementing long-running, highly-concurrent distributed tests.</p></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                   2016.
          All rights reserved.      
                    
      </p>
        </div>

                                                                  
<div class="copyright">Copyright © 2008-2016 Oracle Corporation. All rights reserved.</div>
                                                          
<div class="version">Version 4.0.0-SNAPSHOT: 2016-05-03 02:20</div>
                  
        
                </div>
    </footer>
        </body>
</html>
